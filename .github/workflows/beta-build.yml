name: Beta æ„å»º

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # ------------ æå‰å‡†å¤‡ï¼ˆè¯»å–åŒ…å & ç”Ÿæˆ tag & è¯»å–ç‰ˆæœ¬å·ï¼‰ ------------
  prepare:
    name: å‡†å¤‡æ„å»ºä¿¡æ¯
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.tag.outputs.tag }}
      datetime: ${{ steps.tag.outputs.datetime }}
      pkg: ${{ steps.pkg.outputs.pkg }}
      version: ${{ steps.ver.outputs.version }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v6

      - name: è¯»å– pubspec.yaml åŒ…å
        id: pkg
        run: |
          pkg=$(grep '^name:' pubspec.yaml | awk '{print $2}')
          echo "ğŸ” æ£€æµ‹åˆ°åŒ…å: $pkg"
          if [ -z "$pkg" ]; then
            echo "::error::æ— æ³•ä» pubspec.yaml æ‰¾åˆ°åŒ…å"
            exit 1
          fi
          echo "pkg=$pkg" >> $GITHUB_OUTPUT

      - name: è¯»å– pubspec.yaml ä¸»ç‰ˆæœ¬å·
        id: ver
        run: |
          raw=$(grep '^version:' pubspec.yaml | awk '{print $2}')
          echo "ğŸ” åŸå§‹ç‰ˆæœ¬å·: $raw"

          if [ -z "$raw" ]; then
            echo "::warning::æ— æ³•ä» pubspec.yaml æ‰¾åˆ° version å­—æ®µ"
            echo "version=" >> $GITHUB_OUTPUT
            exit 0
          fi

          version="${raw%%+*}"

          echo "ğŸ“¦ ä¸»ç‰ˆæœ¬å·: $version"
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: ç”Ÿæˆç‰ˆæœ¬æ ‡ç­¾
        id: tag
        run: |
          datetime=$(date -u +"%Y%m%d%H%M")
          tag="v${datetime}"
          echo "â±ï¸ æ„å»ºæ—¶é—´: $datetime"
          echo "ğŸ·ï¸ ç‰ˆæœ¬æ ‡ç­¾: $tag"
          echo "tag=$tag" >> $GITHUB_OUTPUT
          echo "datetime=$datetime" >> $GITHUB_OUTPUT

  # ------------ æ„å»º jobï¼ˆä¾èµ– prepareï¼‰ ------------
  build:
    name: æ„å»º Windows-${{ matrix.arch }}
    needs: prepare
    strategy:
      matrix:
        include:
          - arch: x64
            runs-on: windows-latest
          - arch: arm64
            runs-on: windows-11-arm
    runs-on: ${{ matrix.runs-on }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v6

      - name: è¾“å‡ºæ„å»ºä¿¡æ¯
        shell: pwsh
        run: |
          Write-Host "============================================"
          Write-Host "ğŸ“¦ åŒ…å:        ${{ needs.prepare.outputs.pkg }}"
          Write-Host "â« ç‰ˆæœ¬å·:      ${{ needs.prepare.outputs.version }}"
          Write-Host "ğŸ·ï¸ Tag:         ${{ needs.prepare.outputs.tag }}"
          Write-Host "ğŸ•’ æ—¶é—´:        ${{ needs.prepare.outputs.datetime }}"
          Write-Host "ğŸ–¥ï¸ æ¶æ„:        ${{ matrix.arch }}"
          Write-Host "============================================"

      - name: é…ç½® Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: master

      - name: é…ç½® Rust
        uses: dtolnay/rust-toolchain@stable

      - name: å®‰è£…é¡¹ç›®ä¾èµ–
        shell: pwsh
        run: |
          Write-Host "ğŸ“¦ æ­£åœ¨å®‰è£…é¡¹ç›®ä¾èµ–..."
          
          Write-Host "  â¤ å®‰è£… Flutter ä¸»é¡¹ç›®ä¾èµ–"
          flutter pub get
          
          Write-Host "  â¤ å®‰è£… rinf_cli"
          cargo install rinf_cli
          
          Write-Host "âœ… æ‰€æœ‰ä¾èµ–å®‰è£…å®Œæˆ"


      - name: ç”Ÿæˆ Rust æ¡¥æ¥ä»£ç 
        run: rinf gen

      - name: ç”Ÿæˆå¤šè¯­è¨€æ–‡ä»¶
        run: dart run slang

      - name: æ„å»ºåº”ç”¨ç¨‹åº
        shell: pwsh
        run: |
          Write-Host "ğŸ—ï¸ æ­£åœ¨æ„å»º Release ç‰ˆæœ¬..."
          flutter build windows --release -v
          Write-Host "ğŸ—ï¸ æ­£åœ¨æ„å»º Debug ç‰ˆæœ¬..."
          flutter build windows --debug -v

      - name: æ‰“åŒ…æ„å»ºäº§ç‰©
        shell: pwsh
        env:
          TAG: ${{ needs.prepare.outputs.tag }}
          PKG: ${{ needs.prepare.outputs.pkg }}
          ARCH: ${{ matrix.arch }}
        run: |
          New-Item -ItemType Directory -Force -Path dist | Out-Null

          $pkg = $env:PKG
          $tag = $env:TAG
          $arch = $env:ARCH

          Write-Host "ğŸ”§ æ‰“åŒ…ï¼šåŒ…å=$pkg  Tag=$tag æ¶æ„=$arch"

          $releaseZip = "${pkg}-windows-${tag}-${arch}.zip"
          $debugZip   = "${pkg}-windows-${tag}-${arch}-debug.zip"

          Compress-Archive -Path "build/windows/$arch/runner/Release/*" `
            -DestinationPath "dist/$releaseZip"

          Compress-Archive -Path "build/windows/$arch/runner/Debug/*" `
            -DestinationPath "dist/$debugZip"

          Write-Host "ğŸ“¦ äº§ç‰©æ–‡ä»¶:"
          Write-Host " - dist/$releaseZip"
          Write-Host " - dist/$debugZip"

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ needs.prepare.outputs.pkg }}-windows-${{ matrix.arch }}-${{ needs.prepare.outputs.tag }}
          path: dist/*.zip
          retention-days: 7

  # ------------ ä¸Šä¼ åˆ°å‘å¸ƒé¡µ ------------
  release:
    name: å‘å¸ƒæ„å»º
    needs: [prepare, build]
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: è·å–æäº¤ä¿¡æ¯
        id: commit
        run: |
          # è·å–æäº¤æ¶ˆæ¯
          commit_msg=$(git log -1 --pretty=format:"%s")
          commit_author=$(git log -1 --pretty=format:"%an")
          commit_date=$(git log -1 --pretty=format:"%ci")
          
          # è½¬ä¹‰æ¢è¡Œç¬¦å’Œç‰¹æ®Šå­—ç¬¦
          commit_msg="${commit_msg//$'\n'/'%0A'}"
          commit_msg="${commit_msg//$'\r'/'%0D'}"
          
          echo "message=$commit_msg" >> $GITHUB_OUTPUT
          echo "author=$commit_author" >> $GITHUB_OUTPUT
          echo "date=$commit_date" >> $GITHUB_OUTPUT

      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: é¢„å‘å¸ƒæ„å»ºäº§ç‰©
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.tag }}
          name: Beta ${{ needs.prepare.outputs.datetime }}
          body: |
            ## ğŸš€ Beta æµ‹è¯•ç‰ˆæœ¬
            
            > âš ï¸ è¿™æ˜¯è‡ªåŠ¨æ„å»ºçš„æµ‹è¯•ç‰ˆæœ¬ï¼Œå¯èƒ½å­˜åœ¨æœªçŸ¥é—®é¢˜ï¼Œä»…ä¾›æµ‹è¯•ä½¿ç”¨ã€‚
            
            ### ğŸ“¦ æ„å»ºä¿¡æ¯
            
            | é¡¹ç›® | å†…å®¹ |
            |------|------|
            | **åŒ…å** | `${{ needs.prepare.outputs.pkg }}` |
            | **åº”ç”¨ç‰ˆæœ¬** | `${{ needs.prepare.outputs.version }}` |
            | **æ„å»ºæ—¶é—´** | ${{ needs.prepare.outputs.datetime }} (UTC) |
            | **æäº¤å“ˆå¸Œ** | [`${{ github.sha }}`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}) |
            
            ### ğŸ“ æœ¬æ¬¡æ›´æ–°
            
            **æäº¤è€…**: ${{ steps.commit.outputs.author }}
            **æäº¤æ—¶é—´**: ${{ steps.commit.outputs.date }}
            **æäº¤ä¿¡æ¯**: ${{ steps.commit.outputs.message }}
            
            ---
            
            ### ğŸ“¥ ä¸‹è½½è¯´æ˜
            
            - **Release**: ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–ç‰ˆæœ¬ï¼ˆæ¨èï¼‰
            - **Debug**: å¼€å‘è°ƒè¯•ç‰ˆæœ¬ï¼ˆåŒ…å«è°ƒè¯•ä¿¡æ¯ï¼‰
            
            æ”¯æŒæ¶æ„ï¼š`x64`, `arm64`

          files: artifacts/**/*.zip
          prerelease: true
          overwrite_files: true
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
